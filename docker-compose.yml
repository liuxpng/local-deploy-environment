version: '3.8'

# ============================================
# 网络配置
# ============================================
networks:
  gitea-network:
    name: ${NETWORK_NAME:-gitea-network}
    driver: bridge

# ============================================
# 数据卷配置
# ============================================
volumes:
  gitea-data:
  postgres-data:
  traefik-certs:
  act-runner-data:

# ============================================
# 服务配置
# ============================================
services:
  # ------------------------------------------
  # Traefik 反向代理
  # ------------------------------------------
  traefik:
    build:
      context: ./traefik
      dockerfile: Dockerfile
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - gitea-network
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=${TZ:-Asia/Shanghai}
      - ACME_EMAIL=${ACME_EMAIL}
    volumes:
      # Docker socket - 用于服务发现
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # 配置文件
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      # SSL 证书存储
      - traefik-certs:/letsencrypt
      # 日志
      - ./data/traefik/logs:/var/log/traefik
    labels:
      - "traefik.enable=true"
      # Dashboard 路由
      - "traefik.http.routers.dashboard.rule=Host(`${TRAEFIK_DOMAIN:-traefik.localhost}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      # Dashboard 认证中间件（从 .env 读取）
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_PASSWORD_HASH}"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ------------------------------------------
  # PostgreSQL 数据库
  # ------------------------------------------
  postgres:
    build:
      context: ./postgres
      dockerfile: Dockerfile
    container_name: gitea-postgres
    restart: unless-stopped
    networks:
      - gitea-network
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-gitea}
      - POSTGRES_USER=${POSTGRES_USER:-gitea}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TZ=${TZ:-Asia/Shanghai}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gitea} -d ${POSTGRES_DB:-gitea}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ------------------------------------------
  # Gitea 代码托管平台
  # ------------------------------------------
  gitea:
    build:
      context: ./gitea
      dockerfile: Dockerfile
    container_name: gitea
    restart: unless-stopped
    networks:
      - gitea-network
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_healthy
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME=${POSTGRES_DB:-gitea}
      - GITEA__database__USER=${POSTGRES_USER:-gitea}
      - GITEA__database__PASSWD=${POSTGRES_PASSWORD}
      - GITEA__server__DOMAIN=${GITEA_DOMAIN:-git.localhost}
      - GITEA__server__SSH_DOMAIN=${GITEA_DOMAIN:-git.localhost}
      - GITEA__server__ROOT_URL=http://${GITEA_DOMAIN:-git.localhost}/
      - GITEA__server__HTTP_PORT=${GITEA_HTTP_PORT:-3000}
      - GITEA__server__SSH_PORT=${GITEA_SSH_PORT:-2222}
      # 启用内置 SSH 服务器
      - GITEA__server__START_SSH_SERVER=true
      - GITEA__server__SSH_LISTEN_PORT=${GITEA_SSH_PORT:-2222}
      # 启用 Gitea Actions (CI/CD)
      - GITEA__actions__ENABLED=${GITEA_ACTIONS_ENABLED:-true}
      - GITEA__actions__DEFAULT_ACTIONS_URL=https://github.com
      # 启用 Packages (容器镜像仓库)
      - GITEA__packages__ENABLED=${GITEA_PACKAGES_ENABLED:-true}
      - TZ=${TZ:-Asia/Shanghai}
    volumes:
      - gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      # SSH 端口暴露到宿主机
      - "${GITEA_SSH_PORT:-2222}:2222"
    labels:
      - "traefik.enable=true"
      # HTTP 路由
      - "traefik.http.routers.gitea.rule=Host(`${GITEA_DOMAIN:-git.localhost}`)"
      - "traefik.http.routers.gitea.entrypoints=web"
      - "traefik.http.routers.gitea.service=gitea"
      - "traefik.http.services.gitea.loadbalancer.server.port=${GITEA_HTTP_PORT:-3000}"
      # HTTPS 路由（如果启用）
      # - "traefik.http.routers.gitea-secure.rule=Host(`${GITEA_DOMAIN:-git.localhost}`)"
      # - "traefik.http.routers.gitea-secure.entrypoints=websecure"
      # - "traefik.http.routers.gitea-secure.tls=true"
      # - "traefik.http.routers.gitea-secure.tls.certresolver=letsencrypt"
      # - "traefik.http.routers.gitea-secure.service=gitea"

  # ------------------------------------------
  # Act Runner (Gitea Actions Runner)
  # ------------------------------------------
  act_runner:
    build:
      context: ./act_runner
      dockerfile: Dockerfile
    container_name: act_runner
    restart: unless-stopped
    networks:
      - gitea-network
    depends_on:
      gitea:
        condition: service_started
    environment:
      # Gitea 实例 URL（容器内部访问）
      - GITEA_INSTANCE_URL=http://gitea:3000
      # Runner 注册令牌（需要从 Gitea UI 生成后填入 .env 文件）
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_REGISTRATION_TOKEN}
      # Runner 名称
      - GITEA_RUNNER_NAME=${GITEA_RUNNER_NAME:-default-runner}
      # Runner 标签（定义可用的执行环境）
      - GITEA_RUNNER_LABELS=${GITEA_RUNNER_LABELS:-ubuntu-latest:docker://catthehacker/ubuntu:act-latest}
      - TZ=${TZ:-Asia/Shanghai}
    volumes:
      # 数据持久化
      - act-runner-data:/data
      # 挂载 Docker socket（用于在 runner 中构建 Docker 镜像）
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "traefik.enable=false"
